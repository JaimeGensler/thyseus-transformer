(function(o,t){typeof exports=="object"&&typeof module<"u"?t(exports,require("typescript")):typeof define=="function"&&define.amd?define(["exports","typescript"],t):(o=typeof globalThis<"u"?globalThis:o||self,t(o.thyseus_ts_transformer={},o.ts))})(this,function(o,t){"use strict";const u=new Map;let s=0;function S(e){t.isStatement(e)&&s++}function N(e){u.has(s)||u.set(s,[]),u.get(s).push(e)}function T(e){if(!t.isStatement(e))return e;const r=u.get(s)??[];return u.delete(s),s--,r.length===0?e:t.factory.createNodeArray([e,...r])}const f=new Map;function x(e,r){f.has(e)||f.set(e,new Set),f.get(e).add(r)}function I(e){const r=[],i=new Set;for(const a of e.statements)t.isImportDeclaration(a)&&i.add(a.moduleSpecifier.getText(e)),r.push(a);for(const[a,n]of f){const c=Array.from(n,m=>t.factory.createImportSpecifier(!1,void 0,t.factory.createIdentifier(m)));if(!i.has(`'${a}'`))r.unshift(t.factory.createImportDeclaration(void 0,t.factory.createImportClause(!1,void 0,t.factory.createNamedImports(c)),t.factory.createStringLiteral(a,!0)));else{const m=r.findIndex(l=>t.isImportDeclaration(l)&&l.moduleSpecifier.getText(e)===`'${a}'`),p=r[m],R=[...((p.importClause?.namedBindings).elements??[]).filter(l=>!n.has(l.name.getText())),...c],W=t.factory.updateImportClause(p.importClause,!1,void 0,t.factory.createNamedImports(R));r[m]=t.factory.updateImportDeclaration(p,p.modifiers,W,p.moduleSpecifier,p.assertClause)}}return f.clear(),t.factory.updateSourceFile(e,r)}const y={Query:{descriptorName:"QueryDescriptor",importPath:"thyseus"},Res:{descriptorName:"ResourceDescriptor",importPath:"thyseus"},Commands:{descriptorName:"CommandsDescriptor",importPath:"thyseus"},World:{descriptorName:"WorldDescriptor",importPath:"thyseus"},SystemRes:{descriptorName:"SystemResourceDescriptor",importPath:"thyseus"},EventReader:{descriptorName:"EventReaderDescriptor",importPath:"thyseus"},EventWriter:{descriptorName:"EventWriterDescriptor",importPath:"thyseus"},Mut:{descriptorName:"Mut",importPath:"thyseus"},With:{descriptorName:"With",importPath:"thyseus"},Without:{descriptorName:"Without",importPath:"thyseus"},Or:{descriptorName:"Or",importPath:"thyseus"},Optional:{descriptorName:"Optional",importPath:"thyseus"}};function D(e){return P(e)&&N(t.factory.createExpressionStatement(t.factory.createAssignment(t.factory.createPropertyAccessExpression(e.name,"parameters"),t.factory.createArrayLiteralExpression(h(e).parameters.map(r=>d(r.type)))))),e}function P(e){if(!(t.isFunctionDeclaration(e)||t.isVariableDeclaration(e)&&e.initializer&&(t.isArrowFunction(e.initializer)||t.isFunctionExpression(e.initializer))))return!1;const i=h(e);return!!e.name&&i.parameters.length>0&&i.parameters.every(v)}function h(e){return t.isFunctionDeclaration(e)?e:e.initializer}function v(e){return!!e.type&&g(e.type)in y}function d(e){if(t.isTypeReferenceNode(e)){const r=g(e),i=y[r];return i?(x(i.importPath,i.descriptorName),t.factory.createCallExpression(t.factory.createIdentifier(i.descriptorName),void 0,e.typeArguments?.map(d)??[])):t.factory.createIdentifier(r)}else return t.isTupleTypeNode(e)?t.factory.createArrayLiteralExpression(e.elements.map(d)):t.factory.createIdentifier(e.getText())}function g(e){return t.isTypeReferenceNode(e)?e.typeName.getText():e.getText()}const C="thyseus-ignore";function E(e){if(t.isSourceFile(e))return!1;const r=t.getLeadingCommentRanges(e.getFullText(),0)??[];for(const{kind:i,pos:a,end:n}of r)if((i===t.SyntaxKind.SingleLineCommentTrivia||i===t.SyntaxKind.MultiLineCommentTrivia)&&e.getFullText().substring(a,n).includes(C))return!0;return!1}function F(e){return r=>i=>{function a(n){if(E(n))return n;S(n);const c=t.visitEachChild(D(n),a,r);return T(c)}return I(t.visitNode(i,a))}}function A(e){const r=t.createPrinter();return function(a){t.createProgram([""],{});const n=F(),c=t.createSourceFile("",a,t.ScriptTarget.Latest,!0,t.ScriptKind.TS|t.ScriptKind.TSX),{transformed:m}=t.transform(c,[n]);return r.printFile(m[0])}}o.getTransformer=A,Object.defineProperty(o,Symbol.toStringTag,{value:"Module"})});
